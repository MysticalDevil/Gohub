# 可重构操作文档

本文件定义当前重构的**唯一目标**与执行顺序。除以下目标外，不新增其它重构范围。
本次允许**破坏式 API 变更**与**数据库字段修改**。

## 目标与顺序
1. 使用标准库 `slices` / `maps`
2. 引入泛型（消除重复 util）
3. 统一 `context.Context` 传递
4. 错误聚合（`errors.Join`）
5. 迁移日志到 `log/slog`
6. CLI 与模板使用 `//go:embed`
7. 统一 API 语义（破坏式调整）

## 目标说明与约束
### 1) 使用 `slices` / `maps`
- 替换手写排序、查找、过滤、去重逻辑。
- 禁止引入第三方集合库。
- 保持行为一致，必要时补充或更新单测。

### 2) 引入泛型（消除重复 util）
- 优先使用泛型重构公共查询、分页、请求绑定与响应包装。
- 允许对外 API 与模型接口调整以释放泛型能力。
- 新增泛型 helper 要求有对应单测。

#### 泛型细化用法（建议）
1. **通用查询与存在性检查**
   - 统一 `Get/All/Exists` 语义，减少各模型重复。
2. **分页与列表响应包装**
   - `Paginate` 返回统一结构，减少各控制器差异。
3. **请求绑定与验证抽象**
   - 将重复的 `Bind + Validate` 流程抽成泛型函数。
4. **响应包装**
   - 统一成功/失败响应格式与携带字段。
5. **工厂与测试数据构造**
   - 统一 seed/build 模式，减少测试样板。

### 3) 统一 `context.Context` 传递
- 外部依赖（DB/Redis/邮件/SMS）统一支持 `context.Context`。
- 不强制所有调用方立即改造，允许逐步迁移。
- 默认超时策略需要可配置。

### 4) 错误聚合（`errors.Join`）
- 多步骤/多字段校验统一用 `errors.Join` 聚合。
- 对外响应允许调整，但需保持语义一致并更新文档。

### 5) 迁移日志到 `log/slog`
- 以标准库 `log/slog` 替换现有 zap。
- 完全剔除 zap：替换所有使用点并删除依赖。
- 保持日志结构化输出与可过滤性。
- 继续支持日志文件滚动（保留 lumberjack 或等效方案）。
- 保持 gorm 日志功能（通过自定义 gorm logger 适配）。

### 6) CLI 与模板使用 `//go:embed`
- 脚手架模板与静态资源使用 `//go:embed` 内嵌。
- 保持 CLI 输出与行为一致。
- 删除对磁盘路径的硬依赖。

### 7) 统一 API 语义（破坏式调整）
- 响应格式统一（成功/失败结构一致，字段命名统一）。
- 分页语义统一（分页参数、返回结构、排序默认值）。
- 错误码与错误信息结构统一。
- 允许删除或重命名字段与端点。
- 允许新增 `/v2` 以外的直接替换（本次选择直接替换）。

## 数据库变更策略
1. 允许重命名字段与表结构调整。
2. 所有字段变更必须提供迁移。
3. 迁移前后需补充回归测试与数据回滚策略。

## 执行原则
1. 每个目标拆分成多次小提交。
2. 单提交仅完成一个意图。
3. 每次提交后运行 `go test ./...`。
4. 任何对外接口变更都必须先评审。

## 可选增强（建议纳入重构计划）
1. **结构化错误与错误码统一**  
   统一 `code/message/details`，与 `errors.Join` 形成可组合的错误体系。
2. **请求/响应 DTO 分层**  
   将数据库模型与 API 输出解耦，便于字段变更与版本演进。
3. **统一验证规则与错误消息**  
   验证规则集中管理，减少重复与不一致文案。
4. **日志字段命名规范**  
   迁移到 `slog` 后统一字段命名，例如 `req_id/user_id/route/latency_ms`。

## 验收标准
1. 目标 1-7 全部完成。
2. `go test ./...` 通过。
3. 行为一致、API 语义统一、可回滚。
